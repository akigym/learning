## Pangu-Weather:  用于快速准确全球天气预报的3D高分辨率系统

### 摘要

在本文中，我们介绍了**Pangu-Weather**，这是一个基于深度学习的系统，用于快速准确的全球天气预报。为此，我们通过（ERA5） 数据中下载 43 年的每小时全球天气数据，并训练一些总共约 2.56 亿个参数的深度神经网络，建立了一个数据驱动的环境。预报的空间分辨率为0.25°×0.25°，可与ECMWF综合预报系统（IFS）相媲美。更重要的是，基于人工智能的方法首次在所有因素（例如，**地势、比湿度、风速、温度等**）和所有时间范围（**从一小时到一周**）的准确性（**纬度加权RMSE和ACC**）方面优于最先进的数值天气预报（NWP）方法。提高预测精度的关键策略有两种：（i）设计一种**3D地球特定transformer**（3DEST）架构，将**高度（压力水平）信息表述为立方数据**，以及（ii）应用**分层时间聚合算法**来减轻累积预测误差。在确定性预报方面，盘古天气在中短期预报（即预报时间范围从1小时到1周）方面表现出很大的优势。Pangu-Weather支持广泛的下游预报场景，包括极端天气预报（如热带气旋跟踪）和大成员集合实时预报。Pangu-Weather不仅结束了关于基于AI的方法能否超越传统NWP方法的争论，而且揭示了改进深度学习天气预报系统的新方向。

###  引言

天气预报是科学计算中最重要的场景之一。它提供了预测未来天气变化的能力，特别是极端天气事件（如洪水、干旱、飓风等）的发生，这对社会（如日常活动、农业、能源生产、运输、工业等）有很大的价值。近十年来，随着高性能计算设备的蓬勃发展，数值天气预报（NWP）研究领域迅速发展。传统的NWP方法大多遵循基于模拟的范式，将大气状态的物理规则表述为偏微分方程（PDE），并使用数值模拟进行求解。由于求解偏微分方程的高度复杂性，这些NWP方法通常非常缓慢，例如，空间分辨率为0.25°×0.25°时，使用超级计算机中的数百个节点进行10天预测的单一仿真过程可能需要数小时的计算。这大大降低了每日天气预报的及时性以及可用于概率天气预报的集合成员的数量。此外，传统的NWP算法很大程度上依赖于参数化数值模型，但这些模型尽管非常复杂，但通常被认为是不充分的，例如，未解决过程的参数化会引入误差。

为了解决上述问题，一个有前途的方向在于利用人工智能进行数据驱动的天气预报，特别是深度学习。该方法是使用深度神经网络来捕获输入（观察数据）和输出（要预测的目标数据）之间的关系。在特定的计算设备（例如GPU上，基于AI的方法运行速度非常快，并且很容易在模型复杂性、预测分辨率和预测精度之间实现权衡。作为最近的一个例子，FourCastNet将空间分辨率提高到C，与 ECMWF 综合预报系统 （IFS） 相当，但在四个 GPU 上只需 7 秒即可进行 100 个成员的 24 小时预报，这比传统的 NWP 方法快几个数量级。然而，FourCastNet的预报精度仍不尽如人意，例如，**单一模型和100元集合的5-天Z500预报均方根值**分别为**484.5**和**462.5**，远差于ECMWF业务IFS移植的**333.7**。研究人员推测，在基于AI的方法能够击败NWP之前，“需要一些根本性的突破”。

**5天Z500的RMSE（均方根误差）是一种衡量天气预报精度的指标，特别是用于评估500 hPa高度（即中层大气的高度）在5天预报期内的准确性。RMSE用于量化预测值与实际观测值之间的差异，数值越低表示预报模型的精度越高。**

突破来得比他们想象的要早得多。在本文中，我们介绍了Pangu-Weather，这是一个强大的基于AI的天气预报系统，首次在所有因素的预测准确性方面超过了现有的NWP方法（当然还有基于AI的方法）。Pangu-Weather在era5数据集上进行实验。我们下载了 43 年（1979-2021 年）的全球天气数据，其中我们使用 1979-2017 年的数据进行训练，使用 2019 年的数据进行验证，并使用 2018 ，2020，2021年的数据进行测试。

我们选择了13个气压等级，每个气压等级有5个重要变量（即**地势、比湿度、温度、风速的U分量和V分量**），地表水平有4个变量（即**2m温度、10m风速的u分量和v分量，以及平均海平面气压**）。

图 1 总结了一些关键结果。从数量上看，Pangu-Weather的表现优于所有现有的天气预报系统。特别是，在单杆预报的情况下，Pangu-Weather报告的5天Z500均方根观测值为**296.7**，明显优于可操作的IFS [16]和之前的最佳基于AI的方法（即FourCast Net），分别报告了**333.7和462.5**。此外，Pangu-Weather在单个GPU上的推理成本仅为**1400ms**，比运行中的**IFS快10000**多，与FourCastNet相当。从质量上讲，Pangu-Weather不仅显示高分辨率（0.25°×0.25°）可视化地图（例如，温度和风速），而且还提供高质量的极端天气预报（例如，用于热带气旋跟踪）。Pangu-Weather的技术贡献是双重的。**1.首先，我们将高度信息（由不同压力级别提供）集成到一个新的维度中，使深度神经网络的输入和输出都是三维形式。我们进一步设计了一种 3D 地球专用transformer （3DEST） 架构来处理 3D 数据**。我们的实验表明，尽管3D数据需要更重的计算开销（特别是，大量的内存成本阻碍了我们使用完整的观测元素和非常深的网络架构），但3D模型可以更好地捕捉不同压力水平之间的内在关系，从而产生超过2D对应物的显着精度增益。**其次，我们应用分层时间聚合算法，该算法涉及训练一系列预测提前期增加的模型**（即 1 小时、3 小时、6 小时和 24 小时预测）。因此，在测试阶段，中期（例如，5 天）**预测所需的迭代次数大大减少**，因此，累积预测误差得到缓解。与之前的方法（例如，FourCastNet应用了普通时间聚合和循环优化）相比，我们的策略更容易实施，在训练过程中更稳定，并且实现了更高的中期预测精度。

Pangu-Weather系统基于华为云的GPU系列构建，配备192个NVIDIA Tesla-V100 GPU。每个预测模型都经过 **100 个epochs**的训练，大约需要 15 天。为了最大限度地支持大型神经网络，我们在每个 **GPU 上使用 1 的batch_size，即总批处理大小为 192**。研究中，我们注意到，随着训练数据量的增加和/或训练过程的延长，预测精度会不断提高——100 个epochs，即我们可以使用的最大预算，实际上不足以让训练过程达到完全收敛。也就是说，社区可以等待更多数据（包括增加时间和/或空间分辨率）或使用更强大的计算设备来改进基于人工智能的天气预报。这种趋势类似于在其他人工智能领域建立大规模预训练模型，例如计算机视觉[、自然语言处理、跨模态理解等,

**本文的主要贡献有：**

1.关于基于人工智能的方法是否可以在全球天气预报方面超过NWP。我们建立了一个深度学习框架，该框架首次在全天候变化和从一小时到一周的所有预报时间方面超过了可操作的IFS，同时具有非常快的推理速度和0.25°×0.25°的高空间分辨率。

2.从技术上讲，我们揭示了几个关键问题，这些问题可以显著提高预测的准确性，即（i）使用3D深度神经网络来整合高度信息，以及（ii）应用分层时间聚合来减轻累积预测误差。可以说，这些技术在未来将更加有效，拥有更强大的计算设备和更高质量的训练数据。

3.研究表明，Pangu-Weather能够轻松地将确定性预报的能力转移到极端天气预报、大成员集合预报等下游场景，这些场景的时效性取决于其快速的推理速度。

## Preliminaries and insights

大多数天气预报系统都是建立在观测数据之外的分析或重新分析上的。除了降水等一些因素外，对于大多数大气变量，再分析数据集被认为是最知名的估计。在本文中，我们使用了ERA5数据集，即ECMWF的第5代再分析数据。**ERA5 数据有四个维度，即经纬度、压力水平（高度）和时间**。我们**可以选择任意数量的天气因素（例如，地势、温度等）**，但不要将它们计入新的维度。数据集的总大小超过 2PB，被**分割成 2D（纬度和经度）切片**，以便于下载。也就是说，**给定一个时间点（过去 60 年内每小时）、一个压力水平（或地球表面）和一个天气因素，人们可以下载一个表示指定全球再分析数据的矩阵**。我们将总体ERA5数据表示为A，我们使用上标来指代特定的天气因素和压力水平，使用下标来表示时空坐标，例如，$A^{T850}_{t}$代表时间$t$和高度为850$hPa$的全球温度数据（矩阵），$A^{Z850}_{x,y,t}$代表位置$（x,y）$的地势数据， 时间 为$t$ 和 500$hPa$ 的高度– **请注意，$A^{Z850}_{x,y,t}$是代表单一数字。**

基于ERA5的数据，明确定义了天气预报问题：给定初始时间$t_{0}$，算法应利用所有历史天气数据（即$A^{*}_{t}$表示 $t\leq t_{0}$）来预测未来天气数据（即$A^{*}_{t}$表示 $t> t_{0}$），其中代表所有因素。在开始对现有方法进行调查之前，我们首先注意到，由于以下事实，天气数据的分辨率很高。首先，总共有 **37 × 21+262 观测因子（37 个气压等级，每个气压等级有 21 个天气变量，一个地表有 262 个变量）**，人们认为不同的元素可以相互影响（例如，温度与地势高度相关）。其次，ERA5提供了大约60年的逐小时观测数据，即时间轴的尺度超过$10^5$。第三，空间分辨率为0.25°×0.25°，这意味着全球天气数据的每一帧都是1440×720个数字（即，如果数据要由深度神经网络处理，则为“像素”或“体素”）。正如我们稍后将看到的，高复杂性引起了对NWP和基于AI的方法的计算成本的严重担忧。根据上述定义，天气预报系统被描述为应用于$A^{*}_{t}$的数学函数$f(\cdot )$。天气预报主要有两条研究方向，我们遵循惯例，将它们称为NWP和基于AI的方法。

**NMP 方法**

第一行是传统的数值天气预述NWP方法，它使用模拟来近似$f(\cdot )$。从初始天气状态开始，建立一套偏微分方程（PDE）来模拟热力学等不同的物理过程，如热力学等方程、N-S方程、连续方程等。为了求解偏微分方程，大气状态被划分为离散网格。直观地说，减小格网间距会导致格网数量增加，天气预报的空间分辨率更高，同时也增加了仿真的计算成本。目前，空间分辨率受到超级计算机能力的高度限制。为了加速计算，引入了更多的近似方法，包括1.**插值，它首先形成低分辨率模拟，然后估计网格内的天气状态**以及2**.参数化，它使用近似函数来解决非常复杂的天气过程**——典型的例子包括云和对流的参数化。在这项工作之前，NWP方法总体上贡献了最高的预测精度，但它们仍然受到超线性增加计算开销的困扰，特别是在观测数据量不断增长且难以对NWP方法进行有效的并行化的情况下。NWP的缓慢不仅削弱了IFS系统运行的时效性（例如，大多数此类系统每天只能更新数次预报，而且限制了集合成员的数量（即集合的一组单独的预报结果），从而削弱了概率天气预报的多样性和准确性。此外，NWP方法使用的公式不可避免地会引入近似误差和计算误差这可能会增加迭代或不完整或不准确的分析数据。因此，在考虑越来越多因素的复杂偏微分方程系统中维持NWP方法带来了重大挑战。

**基于AI的方法**

为了减轻上述负担，研究人员开始了第二条线，研究基于人工智能的天气预报方法。人工智能的前沿技术在于深度学习，这是机器学习的一个分支，假设复杂函数（即$f(\cdot )$）可以直接从丰富的训练数据中学习，而无需了解实际的物理过程和/或公式。大多数情况下，$f(\cdot )$ 表现为深度神经网络，通常写为 $f(\cdot ;\theta)$，其中是$\cdot$输入数据的占位符，表示可学习的参数。该网络通常包含许多参数。这些层中的每一层都有大量的可学习参数，这些参数被初始化为白噪声，并通过深度网络的反向传播预测误差进行优化。与天气预报最相似的领域是计算机视觉 （CV），其中图像数据显示在 2D/3D 立方体中。在过去的十年中，CV社区开发了许多有效的网络架构，最近，他们从自然语言处理[39]中移植了一种名为transformers的强大架构，并开发了能够处理图像数据的变体(ViT和swintransformer)。

基于人工智能的方法在效率方面显示出其明显的优势（例如，推理速度比NWP方法快几个数量级）。在 2022 年之前，基于 AI 的方法无法像 NWP 方法那样达到0.25°×0.25°的水平分辨率。最近，FourCastNet将分辨率提高到 0.25°×0.25°，但即使在执行大成员集成后，预测精度（例如，在 RMSE 或 ACC 方面）仍然不如可操作的 IFS。预报准确性和可解释性的缺点，特别是在极端天气事件中，阻碍了基于人工智能的方法的应用。因此，基于人工智能的方法主要在中期天气预报中发挥快速替代模型的作用。

**Insights**

首先，天气预报应考虑高维（例如，3D空间与1D时间）各向异性数据，但现有的基于AI的方法经常处理2D（经纬度）数据。这带来了双重的缺点。一方面，大气状态的间距和分布以及大气块之间的关系在压力水平上变化迅速，使得二维模型难以适应不同的情况。另一方面，许多天气过程（如辐射、对流等）只能在三维空间中完全表述，因此二维模型无法利用如此重要的模式。

其次，当模型被调用太多次时，中期天气预报可能会受到累积预报误差的影响。例如，FourCastNet训练了一个用于 6 小时预测的基础模型，因此执行 7 天的预测需要迭代执行模型 28 次。与NWP方法的情况相比，这种误差可能会迅速增加，因为基于人工智能的方法通常不考虑现实世界的约束（例如，由偏微分方程制定）。根据 FourCastNet 中的结果，预测误差通常会随着时间的推移呈超线性增长。请注意，FourCastNet 应用了一种专门的方法来减少迭代错误，但实际增益在某种程度上是有限的。

综上所述因素，我们得出的见解是，**应尝试增加数据的维数并减少迭代次数，以实现更准确的中期天气预报。**然而，这在计算开销方面遇到了困难，因为天气数据非常大（见第 2.1 节）。在下一部分中，我们将详细阐述一种建立在准确性和效率之间权衡的方法——简而言之，我们使用 3D（纬度、经度和高度）数据作为输入和输出，并针对不同的预测时间间隔训练几个单独的模型，以最大限度地减少中程预测所需的最大迭代次数。

## METHODOLOGY

基于以上的情况，本文提出了自己的Pangu-weather天气预报系统，用于快速准确的全球天气预报。作为一种基于人工智能的方法，它首次超越了传统NWP方法的准确性，同时享有非常快的推理速度。Pangu-Weather的核心部分是一套基于39年全球天气数据训练的深度神经网络，我们在3.2节中详细阐述了数据准备和预训练任务。减少精度损失的关键是双重的，即 （i） 使用 3D 地球专用transformer (3DEST） 有效地模拟 3D 大气结构 – 参见第 3.3 节，以及 （ii） 应用分层时间聚合策略（即训练具有不同提前期的几个模型）以减轻累积预测误差 – 参见第 3.4 节。Pangu-Weather系统可以应用于通用或特定的预报情景，正如我们将在第4节中看到的那样。

**数据处理**

我们使用ERA5数据集，用于训练和评估Pangu-Weather。它包含过去 60 年的全球每小时重新分析数据。利用数值同化方法将观测资料和数值模式预报结果混合到再分析资料中，为全球天气预报提供高质量基准。根据现有的方法，我们在 ERA5 的一个子集上训练我们的模型——特别是，我们使用 1979-2017 年（39 年）的数据进行训练，使用 2019 年的数据进行验证，并使用 2018 年、2020 年、2021 年的数据进行测试。

我们**利用每小时的观测数据，以便算法可以执行每小时的预测**。我们保留了ERA5中可用的最高空间分辨率，即地球球体上的0.25°×0.25°，因此输入分辨率为1440×721（经度为1440，纬度为721 - 请注意，最北端和最南端的数据不重叠）。我们的方法与以往工作的最大区别在于，我们**将高度信息（表示为压力水平）形成到第三空间维度中**。为了降低计算成本，我们按照从总共37个级别中选择13个压力等级（即50hPa、100hPa、150hPa、200hPa、250hPa、300hPa、400hPa、500hPa、600hPa、700hPa、850hPa、925hPa和1000hPa），加上地球表面。为了与在线版的ECMWF控制预测进行公平比较，本文选择对TIGGE数据集中公布的因子进行预测，即5个高空大气变率（**即地势、比湿度、温度、风速的u分量和v分量**）和4个地表天气变量（**即2m温度、10m风速的u分量和v分量，以及平均海平面气压**）。此外，在地表变量的输入中增加了3个常数mask（即地形mask、陆海mask和土壤类型mask）。

**预训练任务**

预训练任务很简单，即要求模型根据历史观测数据预测未来的天气。从技术上讲，这涉及从数据集中抽取时间点 $t$（即日期和小时）并指定预测差距$\Delta t$ ，以便模型 $f(\cdot;\theta)$将 $A^{*}_{t}$ 作为输入并预测$\hat{A}^{*}_{t+\Delta t}$ ，目标是接近$A^{*}_{t+\Delta t}$ 。在深度学习的上下文中,$f(\cdot;\theta)$显示为可微函数，以便计算 $\hat{A}^{*}_{t+\Delta t}$ 和 $A^{*}_{t+\Delta t}$ 之间的差值并反向传播以更新参数 。技术细节，包括 $f(\cdot;\theta)$ 的设计和 $\Delta t$ 值的选择，将在以下小节中详细说明。

**3DEarth-Specific Transformer**

本部分介绍$f(\cdot;\theta)$ 的设计。我们将其命名为 3D 地球专用Transformer （3DEST）。3DEST的整体架构如图2所示。它是视觉转换器ViT的一种变体，其输入和输出是指定时间点的3D天气状态。对于单个模型，输入和输出状态之间的提前期是固定的，例如，$\Delta t$等于 6 小时。我们通过聚合具有不同提前期的多个模型来实现任何时间的天气预报。

模型的输入和输出数据有两个来源，即高空变量和地表变量。前者涉及 13 个压力级别，它们组合在一起提供 13×1440×721×5数据块。后者包含一个 1440×721×4 立方体。这些参数首先从原始空间嵌入到$C$维潜在空间中。计算机视觉中一种常见的技术方法，**称为patch embedding**，用于降维操作。对于高空部分，patch尺寸为 2×4×4，因此数据嵌入形状为 7×360 ×181×C。对于地表变量，patch尺寸为 4×4，因此数据嵌入形状为 360×181×C。然后，将这两个数据立方体沿第一个（高度）维度连接起来，以产生一个 8×360×181×C 立方体。然后，立方体通过具有 8 个编码器层和 8 个解码器层的标准编码器-解码器架构进行传播。解码器的输出仍然是一个 8×360×181×C立方体，该立方体通过patch恢复投影到原始空间，产生所需的输出。

![image-20240730183319148](C:\Users\龚宇蒙\AppData\Roaming\Typora\typora-user-images\image-20240730183319148.png)

**patch embedding和patch recovery**。为此，我们遵循标准的ViT，使用具有 GeLU 激活功能的线性层。在我们的实现中，一个补丁有 2×4×4个像素用于高空变量，4×4 个像素用于地表变量。滑动窗口的步幅与patch大小相同，当数据大小被patch大小不可分割时，将添加必要的零值填充。对于高空变量，patch embedding的参数个数为$(4\times4\times2\times5)\times C$，对于表面变量，参数个数为$(4\times4\times4)\times C$。patch recovery恢复执行相反的操作，但它不会与补丁嵌入共享参数。

**encoder-decoder结构**。前 2 个编码器层的数据大小保持不变$(8\times360\times181\times C)$，而接下来的 6 层，水平维度减少了 2 倍，通道数增加了一倍(**使用的是swin transformer里的Patch Merge 操作**)，导致数据大小为$(8\times180\times91\times 2C)$。解码器部分与编码器部分对称，前 6 个解码器层的大小为 $(8\times180\times91\times 2C)$，接下来的 2 层大小为$(8\times360\times181\times C)$ 。**第 2 编码器层和第 7 解码器层的输出沿通道维度连接。下采样和上采样操作连接不同分辨率的相邻层，我们遵循Swin transformer的实现**。对于下采样，我们将四个**tokens**合并为一个（特征维数从$C$增加到 $4C$），并通过线性层以将维度降低到 $2C$。对于上采样，将执行反向操作。

![image-20240730183548372](C:\Users\龚宇蒙\AppData\Roaming\Typora\typora-user-images\image-20240730183548372.png)

**3D 地球专用Transformer 块**。每个编码器和解码器层都是一个 3D 地球专用transformer （3DEST） 模块。它类似于标准的ViT block，但专门设计用于与地球的几何形状对齐。为了进一步降低计算成本，我们继承了窗口注意力机制，将特征图（$8\times360\times181$或$8\times180\times91$——最后一个维度省略）划分为窗口，每个窗口最多包含$2\times12\times6$个tokens。标准的自我关注机制在每个窗口中应用。应用了**滑动窗口注意机制**，以便每一层的网格划分都与上一层窗口大小的一半是不同的。

**Earth-specific positional bias。**Swin transformer 使用相对位置偏差来表示注意力的平移不变分量，其中，偏差是根据每个窗口的相对坐标计算的。但是，对于全球天气预报，情况有所不同。每个token对应地球坐标系上的一个绝对位置，并且，由于地图是地球球体的投影因此，相邻token之间的距离可以不同——参见图3。更重要的是，某些天气状态与绝对位置紧密相关。地势、风速和温度的示例如图3所示。为了获取这些属性，我们将B修改为地球特定的位置偏差，称为BESP，将位置偏差添加到每个令牌基础上，设置绝对（而不是相对）坐标。

从数学上讲，让整个特征图的空间分辨率为 $N_{pl}\times N_{lat}\times N_{lon}$，其中 $N_{pl}$、$N_{lat}$和 $N_{lon}$分别表示沿高度（按压力水平）、纬度和经度轴的大小。Swin transformer 将这些神经元划分为  $M_{pl}\times M_{lat}\times M_{lon}$窗口，每个窗口都有 $W_{pl}\times W_{lat}\times W_{lon}$的大小。地球特定位置偏差矩阵包含  $M_{pl}\times M_{lat}$ 子矩阵（ **$M_{lon}$ 不会出现，因为不同的经度值具有相同的偏差 - 经度指数是循环的，并且间距沿该轴均匀分布**），每个子矩阵都包含 $W^2_{pl}\times W^2_{lat} \times(2W_{lon}-1)$ 可学习参数。当注意力在同一窗口内的两个patch 计算时（Swin不计算窗口间注意力），我们使用窗口坐标$（m_{pl}\times m_{lat}\times m_{lon}）$来定位相应的偏置子矩阵（$m_{lon} $is not used），然后使用窗口内坐标$（h^{'}_{1},\phi^{'}_{1},\lambda^{'}_{1}）$and$（h^{'}_{2},\phi^{'}_{2},\lambda^{'}_{2}）$，来调用子矩阵的偏置值$(h^{'}_{1}+ h^{'}_{2}\times W_{pl},\phi ^{'}_{1}+\phi^{'}_{2}\times W_{lat},\lambda^{'}_{1}-\lambda^{'}_{2}+W_{lon}-1)$。

应用地球特定位置偏差会带来两方面的不同。首先**，它使地球大气层的分布情况能够更好被模型表述：在每个注意力块中，地球特定位置偏差学习了不同纬度和高度的tokens之间的不同空间关系，从而纠正了由不均匀的地形分布带来的非均匀性**。其次，与原版本（所有窗口共享相同位置偏差）相比，各transformer的可学习参数数量从$（2W_{pl}-1）\times （2W_{lat}- 1）\times（2W_{lon}- 1）$大幅增加到$M_{pl}\times M_{lat}\times W^2_{pl}\times W^2_{lat} \times（2W_{lon}- 1）$。在第一个区块中，后一个参数数量比前一个大约大 527倍。大量的偏置参数使每个模块能够灵活地学习每个变量的特定模式，例如图 3 中所示的关系。在实践中，我们在优化大量参数时没有观察到任何困难。取而代之的是，模型在训练过程中收敛得更快，因为有用的先验知识已被引入。此外，地球特异性位置偏置并未增加模型的FlOPs。

**Design choices**

我们将简要讨论其他设计选择。由于计算开销大，我们没有对超参数进行详尽的评估或诊断研究，我们相信存在导致更高准确性的配置。首先，我们使用了8（2+6）个编码器和解码器层，这比标准的Swin transformer要少得多，这是为了降低时间和内存的复杂度。Ifone拥有更大的GPU内存和更强大的集群，增加网络深度可以带来更高的准确性。其次，可以通过共享或其他技术中使减少地球特定位置偏置用的参数数量。但是，我们不将其作为一个关键问题作为考虑，因为不太可能将天气预报模型部署到存储受限的边缘设备上。第三，将更多时间点的天气状态输入模型是可能的，并且很有希望，这会将所有张量从 3D 更改为 4D。虽然我们相信这样的修改可以提高准确性，但有限的计算预算使我们无法进行这项试验。

**分层的时间聚合**

当目标是进行中期天气预报（例如，预报时间长达5天），但基础预报模型的预报时间相对较短（例如，FourCastNet训练的模型的预报时间为6小时），系统必须**多次迭代执行模型**，并且**累积的预报误差可能会不断增加**。如图 4 所示，我们模拟 FourCastNet 执行 6 小时模型 28 次，以实现长达 7 天的预测，我们发现随着迭代的进行，预测精度会迅速下降。毫不奇怪，如果将基本提前期设置为 1 小时（即模型执行 168 次），预测准确性会急剧下降，但如果提前期为 24 小时（即执行 7 次），则预测精度下降会大大缓解。这意味着，对于中期甚至长期预测，系统可以从抑制累积预测误差中受益匪浅。为此，我们利用了一种简单而有效的策略，称为分层时间聚合。我们分别训练了**四个单独的模型进行 1 小时、3 小时、6 小时和 24 小时预测**。我们不会继续延长预报时间，因为这大大增加了训练基础模型的难度。在测试阶段，给定一个预测目标，我们使用贪婪算法来保证最小的迭代次数。例如，对于 7 天预测，我们执行 24 小时预测 7 次，而对于 23 小时预测，我们执行 6 小时预测 3 次，然后是 3 小时预测 1 次，1 小时预测 2 次。

**分层时间聚合使训练和测试**阶段都更加高效。对于训练，它避免了执行递归优化，因为许多现有的工作都这样做了，例如，FourCast Net  计算了 $f（A）$和 $f（f（A））$并产生了两个损失项——虽然迭代错误确实被抑制了，但是每个模型都需要两个GPU内存，从而抑制了模型大小，这是改进的关键因素之一。此外，它避免了训练可能不稳定的递归神经网络。对于测试，尤其是当预测范围很大时，它可以减少预测的数量以及时间复杂度。使用 Adam 优化器对四个单独的模型进行 100 个epochs的训练。**在 192 个 NVIDIA Tesla-V100 GPU 上，每个完整的训练过程需要 16 天。我们发现，在100个周期结束时，所有模型还没有完全收敛，但是有限的计算预算使我们无法继续进行训练过程。**采用$3\times10^6$的权重衰减和drop率为$0.2$的DropPath，避免过拟合。

### 实验结果

我们报告了Pangu-Weather在两个数据集上的预测结果。第一个是ERA5的保留部分，用于对全球确定性天气预报进行全面评估。第二个是国际气候管理最佳轨道档案（IBTrACS）数据集的第4版，用于评估跟踪热带气旋的能力，**热带气旋是极端天气预报的一个特例。**我们将**Pangu-Weather与NWP和AI两个领域中最强的方法**进行比较，即ECMWF（downloadedfromtheTIGGEarchive) 提供的IFS和FourCastNet。对于热带气旋追踪，我们还下载了ECMWF-HRES预报，作为IBTrACS中对抗盘古天气的更强竞争者。据我们所知，以前没有任何基于人工智能的方法报告过热带气旋追踪的定量结果。

**确定性天气预报**

盘古天气的确定性预报是在ERA5的无扰动初始状态上进行的。Pangu-Weather的预报分辨率由训练数据（即ERA5）确定，其中空间分辨率为0.25°×0.25°，与ECMWF ENS 的控制预报相当，与FourCastNet 相同，但预报间隔（最短预报时间）为1 h（即Pangu Weather可以提供逐小时预报），比FourCastNet小6倍。

遵循以往基于人工智能的方法，确定性预测的准确性由两个定量指标计算，即纬度加权均方根误差（RMSE）和纬度加权异常相关系数（ACC）。对于一个指定的时间节点$t$,任意变量$v$(2m温度或500hPa地势)的RMSE和ACC定义为以下内容：
$$
RMSE(v,t)= \sqrt{\frac{\sum_{i=1}^{N_{lat}}\sum_{j=1}^{N_{lon}}L(i)(\hat{A}^{v}_{i,j,t}-A^v_{i,j,t})^2}{N_{lat}\times N_{lon}}}\\
\\
ACC(v,t)=\frac{\sum_{i,j}L(i)\hat{A}^{'v}_{i,j,t}A^{'v}_{i,j,t}}{\sqrt{\sum_{i,j}L(i)(\hat{A}^{'v}_{i,j,t})^2\times \sum_{i,j}L(i)(A^{'v}_{i,j,t})^2}}
$$
**高空大气变量**

在13个气压等级（即50hPa、100hPa、150hPa、200hPa、250hPa、300hPa、400hPa、500hPa、600hPa、700hPa、850hPa、925hPa和1000hPa）的5个重要高空变量（即**地势、比湿度、温度、风速的u分量和v分量**），空间分辨率为0.25°×0.25°。这极大地简化了与可操作的IFS和FourCastNet的比较，这是基于NWP和AI的最佳方法。测试环境建立在20186年的天气数据上。按照IFS的操作，我们选择2个时间点（00：00UTCand12：00UTC）作为每个周的预测开始时间，然后对接下来的一周每小时进行一次结果预报，即预报时间为1h，2h， 168h=7d。 定量比较主要集中在pangu和IFS上，而与其他基于AI的方法的比较是不完全的，因为在测试子集，后续处理方法的空间分辨率是不同的。

Pangu-Weather与IFS之间的比较结果，其中与IFS相比，Pangu-Weather在预测准确性方面（在所有预测时间和所有变量下）都表现的更好。随着预报时间的增加，这一优势变得更加显着，**这意味着基于人工智能的方法更擅长捕捉中期天气预报的有效（尽管无法解释）模式**。具体来说，我们注意到，Pangu-Weather相对于IFS的“预测优势时间”（即，在相同预测精度下的预测时间差异）对于所有预测变量都超过12小时，对于特定湿度超过24小时，**这意味着基于AI的方法在预测特定变量方面明显更好。**

![image-20240801171239823](E:\Research\学习笔记\image-20240801171239823.png)

具体来说，我们研究了500hPa地势和850hPa温度，这些变量在以前的基于人工智能的方法中被广泛报道。这两个变量的定量比较如图所示。Pangu-Weather的预报精度始终高于IFS和Four CastNet，后者是以前最好的基于AI的方法，但弱于IFS。从数量上看，对于Z500，运行IFS的3天和5天RMSE（单位为$m^2/s^2$）分别为**152.8和333.7**，Pangu-Weather将其减少到**134.5和296.7**（如果包括2018年12月的数据，则为**133.9和294**）。对于 T850，运行 IFS 的 3 天和 5 天 RMSE（以 K 为单位）分别为 **137 和 206**，Pangu-Weather 将它们减少到 **114 和 179**（如果包括 2018 年 12 月的数据，则为 **113 和 177**），相对误差下降了 10% 以上。在所有情景下，RMSE 的相对下降幅度都超过 10%，这也反映在 10-15小时的“预测时间增益”中。与FourCastNet相比，我们观察到精度的提高更加显著——在上述情况下，RMSE的相对降低超过30%，并且“预测时间增益”也扩大到36小时以上。

**地表天气变量**

Pangu-Weather预报了4个重要的地表变量，即2m气温、10m风速的u分量和v分量、平均海平面气压。与高空变量相比，这些地表变量与地形和人类活动（如城市热岛效应）有着密切而复杂的关系，因此更难预测。测试环境的建立方式与预测高空变量类似。对Pangu-Weather与之前的最佳NWP方法（即IFS）和基于AI的方法（即FourCastNet）进行了定量比较，其中FourCastNet和IFS的数值比较结果如图所示。同样，Pangu-Weather在所有预测时间、所有变量的预测准确性方面都优于两个竞争对手，并且优势变得更加显著随着预报时间的增加。**所有这些变量的“预测时间增益”约为 18 小时**，略长于预测高空变量的增益。我们研究了单独变量的预测准确性。对于2m温度（T2M），3天和5天均值（K）分别为**1.34和1.75**（IFS），FourCastNet分别为**1.39和2.00**，Pangu-Weather将其降低到**1.05和1.53**（6小时测试间隔为1.06和1.52）。对于10m风速（U10）的u分量，运行IFS的3天和5天均方根（m/s）分别为**1.94和2.90**，FourCastNet分别为**2.24和3.41**，Pangu Weather将其降低到**1.61和2.53**（2018年测试数据为1.61和2.55，测试间隔为6 h）。省略了10m风速（V10）的V分量的数值比较，因为它与U10的风速趋势几乎相同。我们有平均海平面气压 （MSLP） 变量的预测结果，但由于 ECMWF的数据不可用，我们无法提供与IFS的定量比较。我们认为，由于两个原因，我们的预测是最好的。一方面，根据前人经验，对其他地表变量（即T2M、U10、V10）预测效果更好的模型在MSLP上也具有更高的预测精度。另一方面，我们利用MSLP的预测来追踪热带气旋——如下所示，**Pangu-Weather在2018年预测88个命名热带气旋时，在数量和质量上都比操作的IFS取得了更好的结果**。

此外，我们还在Weather Bench上评估了Pangu-Weather，这是低分辨率天气预报的基准。为此，我们简单地将盘古天气预报结果扩大22.5倍下采样到空间分辨率为5.625°×5.625°的粗网格中，并将结果与下采样的ERA5地面实况进行比较。从数量上看，运行IFS在WeatherBench上报告的T2M的3天/5天RMSE均值为1.35/1.77，Pangu-Weather分别为1.04/1.51。

![image-20240801172335654](E:\Research\学习笔记\image-20240801172335654.png)

![image-20240801174438075](E:\Research\学习笔记\image-20240801174438075.png)

**可视化**

在下图中，我们首先在两个高空变量Z500和T850上可视化了盘古天气的72小时预报，并将结果与实际的IFS和ERA5地面实况进行了比较。两种预测结果都足够接近地面实况，但人们可以检测到它们之间的差异。Pangu-Weather 产生更平滑的等值线，我确信该模型倾向于预测邻近区域的相似值——这是深度神经网络在从大规模数据集中学习的典型特性。相比之下，IFS 倾向于保留小规模结构，但不能保证此类预测是正确的。

![image-20240801181306407](E:\Research\学习笔记\image-20240801181306407.png)

**存在的问题分析**

本文应用了一种**基于分层时间聚合的贪婪算法**，如第 3.4 节所述。对于某些变量（例如，Q500 和 T2M），我们观察到一个**明显的趋势**，即**预测精度随着迭代次数的增加而下降**，例如，**72 小时预测需要 3 个调用，而 71 小时预测需要 8 个调用（即 71 = 24 + 24 + 6 + 6 + 6 +3+1+1），因此由于累积预测误差，71 小时的精度要低得多。**虽然我们可以通过向前移动时间点来轻松提高准确性（**例如，使用 1 小时前的天气状态进行 72 小时预报以进行 71 小时预报**），但我们仅在此处提供原始预报结果来展示这种重要的现象。这就要求未来采用先进的时间聚合算法——一种可能性是将时间轴集成到输入数据中并利用 4D 深度神经网络，但这意味着计算开销要大得多。

**计算开销**

基于人工智能的方法的明显优势在于**推理速度**。FourCastNet 声称比传统的 NWP 方法提高了 **45000 倍**的加速，Pangu-Weather 与 FourCastNet 相当。除了在预报准确性方面的优势外，Pangu-Weather还具有取代传统NWP的潜力，使实时天气预报可以在任何时间（例如，每秒一次）进行，而不是目前每天仅执行几次天气预报的状态。预计会有一些附带好处。（i） **它大大提高了短期天气预报的及时性，而短期天气预报对于警告短期极端天气，例如暴雨，非常重要**。（ii）**能够进行大成员集合预报，对气象学家关注敏感的天气因素或变量具有重要意义**。Pangu-Weather的推理速度与FourCastNet相当，这意味着使用整体3D深度神经网络进行推理比使用2D的成本略高，但精度要高得多。在系统级比较中，FourCastNet 在 NVIDIA Tesla-A100 GPU（312 TeraFLOPS）上推断 24 小时预报需要 280 毫秒，而在 NVIDIA Tesla-V100 GPU （120 TeraFLOPS） 上，Pangu-Weather 需要 1400 毫秒。考虑到 GPU 性能，Pangu-Weather 比 FourCastNet 慢约 50%，同时仍然是高分辨率全球天气预报最快的系统之一。为了进一步加速 Pangu-Weather，我们可以训练具有更长交货时间（例如 72 小时）的模型，以减少时间聚集的数量。我们预计在不久的将来会探索这个方向。

### 极端气象分析

极端天气预报在全球天气预报中起着至关重要的作用。尽管这种情况很少发生，但飓风等极端天气事件可能会带来巨大的伤亡和经济损失。因此，预计天气预报系统可以警告即将发生的极端天气事件，以补充每日天气报告。本文将pangu-weather和传统的NWP方法在预测极端天气事件方面的能力进行了比较，首先在引入一个定量计量，命名为相对量度误差来衡量总体趋势，然后研究追踪热带气旋这个特殊和重要的情况。

**极端天气预测的总体趋势**

我们使用与[51]类似的方法根据预测结果和地面实况计算的top-level分位数的值来进行比较。在数学上，我们设置了D=50个百分位数，表示为$q_1,...,q_D$,和FourCastNet [14]，设置$q_1=90\%,q_D=99.99\%$，中间位数在对数刻度上线性分布在$q_1$和$q_D$之间。然后，分别计算相应的分位数（表示为$Q_1,...,Q_D$），分别用于天气变量和预测时间，例如，对于U10的所有3天预报，从所有帧中汇总像素值以进行统计。最后，使用相对分位数误差（RQE）来衡量地面实况与任何天气预报系统之间的差异：
$$
RQE=\sum_{d=1}^{D}\frac{\hat{Q_d-Q_d}}{Q_d}
$$
![image-20240802143552489](E:\Research\学习笔记\image-20240802143552489.png)

RQE可以衡量总体趋势，其中RQE<0和RQE>0分别暗示了预测系统倾向于低估和高估极端的强度。所有三种方法都倾向于低估极值，即RQE值始终小于0。**基于AI的方法报告的绝对RQE值通常随着预测时间的增长而增长**（即，重度低估），而IFS的绝对值则基本保持不变.我们将上述观测结果归因于基于AI的方法的累积预测误差——与FourCastNet相比，盘古天气显著减少此类误差与分层时间聚合。与IFS相比，Pangu-Weather对U500的绝对RQE值（即重度低估）较高，对Q500的绝对RQE值（即轻度低估）较低。关于U10，盘古天气比IFS好得多，最多3天（72小时），然后由于累积预报误差而变得略差。

**热带气旋追踪**

Pangu-weather追踪热带气旋眼的优点主要沿袭了确定性预报的优点，特别是**对气旋眼定位至关重要的平均海平面气压预报**。可以说，该提出的3DEST架构结合了三维信息，以提高地势、风速和平均海平面气压等重要变量的精度。另一方面，我们注意到pangu-weather仍然**严重低估了热带气旋的强度**，可以说是由于ERA5数据的同样弱点。未来，我们期望可以建立更高分辨率、更准确的训练数据，用于对极端天气预报的这些特定场景进行微调盘古天气。

**集合天气预报**

集成天气预报的核心目标是研究预报系统的不确定性，即**预报结果与小扰动的变化**。研究者主要考虑了两种不确定性，包括（i）初始天气状态和（ii）模型参数。其目的是诊断观察或重新分析数据中的错误（例如，由同化引起[35]）以及NWP和基于AI的模型的偏差（例如，偏向于错误模式）。集合预报的方法主要**涉及在初始天气状态或模型参数中添加噪声**，并观察预报结果的变化。它们中的任何一个都需要多次执行推理。Pangu-Weather作为一种基于AI的方法，其推理速度比传统的NWP方法快得多，例如，比IFS快10000多倍。这为执行大集合预报提供了相对较低的计算成本的机会。因此，我们提供基于Pangu-Weather的集合预报的独立研究，但我们相信气象学家可以提供专业知识，以进一步利用集合预报的能力。

在本文中，我们主要研究了在初始天气状态中增加扰动的第一条线。为简单起见，我们遵循FourCastNet将扰动设置为随机Perlin噪声，同时我们认为更丰富的气象逻辑知识可以帮助我们开发更高级的集合方法（例如，基于奇异向量）。从数学上讲，让初始天气状态为 $A_t^*$，我们随机生成 S = 99 个 $A_t$ 大小相同的 Perlin 噪声向量，表示为 $P_1,..., P_S$。初始状态被扰动为 $A_t + \eta P_s$，其中 $\eta= 0.2$ 是控制噪声幅度的系数，$s = 0,1,..., S$，其中$ s =0$表示不添加噪声，即 $P_0 \equiv0$。我们将所有 $S +1$个初始状态输入给训练好的模型，并将输出平均作为最终的集合预测结果。仍在2018年对ERA5天气数据进行实验，其中确定性预报作为baselines。如图所示，在短程（如1天）天气预报中，100元集合预报的精度略低于单元确定性预报，但当预报时间超过5 天时，精度明显高于确定性预报。这与我们的直觉和先前工作的观察结果一致，表明当单模型精度降低时，大成员集合预测特别有用，但当确定性预测足够准确时，它可能会引入可能导致精度下降的意外噪声。此外，集合预报对500hPa比湿度（Q500）和10m地面风速（U10）等非平稳变量具有更多优势，如Z500和U10的7天预报纬度加权RMSE从500.3和3.48降低到450.6和2.96，相对下降幅度分别为10%和15%。

本文暂时不研究另一条线（即**向模型参数添加扰动**），因为Pangu-Weather基于包含数亿个参数的深度神经网络，这与传统的NWP模型不同，后者包含的参数要少得多，但在物理上却意义重大。此外，在训练过程中，学习到的参数对一些随机因素（例如，随机种子、数据采样策略等）高度敏感，因此很难为特定目的受到干扰。未来，我们期望将基础的盘古天气模型微调为一系列用于操纵不同因素的“子模型”。

![image-20240802155923698](E:\Research\学习笔记\image-20240802155923698.png)

### 总结

在本文中，我们介绍了Pangu-Weather，一种基于AI的数值天气预报系统。技术贡献涉及 **（i） 设计 3D 地球专用transforme（3DEST） 架构和 （ii） 应用分层时间聚合策略**。通过在39年的全球天气数据上训练深度神经网络，Pangu-Weather首次在准确性和速度上都超过了传统的NWP方法。Pangu-Weather为气象学家打开了一扇窗户，将他们的知识整合到基于人工智能的方法中，以获得更令人兴奋的应用。展望未来，我们预计计算资源是进一步提高天气预报准确性的关键。根据我们的实验，训练过程尚未达到完全收敛，在（i）**引入更多观测元素作为输入**（ii）**整合时间维度并训练4D深度网络**以及（iii）**仅使用更深和/或更宽的网络进行模型训练**。这方面还有很大的空间。所有这些都需要更强大的 GPU、更大的内存和更高的 FLOPs。
